
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Simple Rule Server explained.">
      
      
      
        <link rel="canonical" href="https://sim0njo.github.io/docs/SimpleRuleServer/">
      
      
        <link rel="prev" href="../PhcModules/">
      
      
        <link rel="next" href="../Downloads/">
      
      
      <link rel="icon" href="../img/favicon.ico">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.5.49">
    
    
      
        <title>Simple Rule Server - Jo Simons</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.6f8fc17f.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Barlow:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Barlow";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#intro" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow md-header--lifted" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Jo Simons" class="md-header__button md-logo" aria-label="Jo Simons" data-md-component="logo">
      
  <img src="../img/home.gif" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Jo Simons
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Simple Rule Server
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 6H7c-3.31 0-6 2.69-6 6s2.69 6 6 6h10c3.31 0 6-2.69 6-6s-2.69-6-6-6m0 10H7c-2.21 0-4-1.79-4-4s1.79-4 4-4h10c2.21 0 4 1.79 4 4s-1.79 4-4 4M7 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="indigo" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M17 7H7a5 5 0 0 0-5 5 5 5 0 0 0 5 5h10a5 5 0 0 0 5-5 5 5 0 0 0-5-5m0 8a3 3 0 0 1-3-3 3 3 0 0 1 3-3 3 3 0 0 1 3 3 3 3 0 0 1-3 3"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
    
      
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../Phc2Mqtt/" class="md-tabs__link">
          
  
  Phc2Mqtt

        </a>
      </li>
    
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="../Downloads/" class="md-tabs__link">
        
  
    
  
  Downloads

      </a>
    </li>
  

      
        
  
  
  
    <li class="md-tabs__item">
      <a href="http://sim0njo.github.io/install" class="md-tabs__link">
        
  
    
  
  ESP Web Installer

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
    
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Jo Simons" class="md-nav__button md-logo" aria-label="Jo Simons" data-md-component="logo">
      
  <img src="../img/home.gif" alt="logo">

    </a>
    Jo Simons
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
    
  
  
  
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" checked>
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Phc2Mqtt
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Phc2Mqtt
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../Phc2Mqtt/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    User Manual
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../PhcModules/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Phc Modules
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Simple Rule Server
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Simple Rule Server
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    <span class="md-ellipsis">
      Intro
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rule-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Rule Syntax
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internal-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Internal Objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-object" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-object" class="md-nav__link">
    <span class="md-ellipsis">
      State Object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-object" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Object
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      Events
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topic-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Topic Formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Data Formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-sources" class="md-nav__link">
    <span class="md-ellipsis">
      Event Sources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      Event Filtering
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditions" class="md-nav__link">
    <span class="md-ellipsis">
      Conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-condition" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-condition" class="md-nav__link">
    <span class="md-ellipsis">
      State Condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-condition" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Condition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actions" class="md-nav__link">
    <span class="md-ellipsis">
      Actions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-action" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mqtt-action" class="md-nav__link">
    <span class="md-ellipsis">
      MQTT Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stmd-action" class="md-nav__link">
    <span class="md-ellipsis">
      STMD Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-action" class="md-nav__link">
    <span class="md-ellipsis">
      State Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-action" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Action
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rules" class="md-nav__link">
    <span class="md-ellipsis">
      Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Init Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exit-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Exit Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-rule" class="md-nav__link">
    <span class="md-ellipsis">
      State Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Action Rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rule-samples" class="md-nav__link">
    <span class="md-ellipsis">
      Rule Samples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rule Samples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samples-for-text-or-json-report-format" class="md-nav__link">
    <span class="md-ellipsis">
      Samples for Text or JSON report format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples-for-xphclogd-report-format" class="md-nav__link">
    <span class="md-ellipsis">
      Samples for xPhcLogd report format
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../Downloads/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Downloads
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="http://sim0njo.github.io/install" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ESP Web Installer
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#intro" class="md-nav__link">
    <span class="md-ellipsis">
      Intro
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rule-syntax" class="md-nav__link">
    <span class="md-ellipsis">
      Rule Syntax
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#internal-objects" class="md-nav__link">
    <span class="md-ellipsis">
      Internal Objects
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Internal Objects">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-object" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-object" class="md-nav__link">
    <span class="md-ellipsis">
      State Object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-object" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Object
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#events" class="md-nav__link">
    <span class="md-ellipsis">
      Events
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Events">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#topic-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Topic Formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#data-formats" class="md-nav__link">
    <span class="md-ellipsis">
      Data Formats
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-sources" class="md-nav__link">
    <span class="md-ellipsis">
      Event Sources
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#event-filtering" class="md-nav__link">
    <span class="md-ellipsis">
      Event Filtering
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#conditions" class="md-nav__link">
    <span class="md-ellipsis">
      Conditions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Conditions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-condition" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-condition" class="md-nav__link">
    <span class="md-ellipsis">
      State Condition
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-condition" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Condition
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#actions" class="md-nav__link">
    <span class="md-ellipsis">
      Actions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Actions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#clock-action" class="md-nav__link">
    <span class="md-ellipsis">
      Clock Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#mqtt-action" class="md-nav__link">
    <span class="md-ellipsis">
      MQTT Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#stmd-action" class="md-nav__link">
    <span class="md-ellipsis">
      STMD Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-action" class="md-nav__link">
    <span class="md-ellipsis">
      State Action
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#timer-action" class="md-nav__link">
    <span class="md-ellipsis">
      Timer Action
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rules" class="md-nav__link">
    <span class="md-ellipsis">
      Rules
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rules">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#init-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Init Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#exit-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Exit Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#state-rule" class="md-nav__link">
    <span class="md-ellipsis">
      State Rule
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#action-rule" class="md-nav__link">
    <span class="md-ellipsis">
      Action Rule
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#rule-samples" class="md-nav__link">
    <span class="md-ellipsis">
      Rule Samples
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Rule Samples">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#samples-for-text-or-json-report-format" class="md-nav__link">
    <span class="md-ellipsis">
      Samples for Text or JSON report format
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#samples-for-xphclogd-report-format" class="md-nav__link">
    <span class="md-ellipsis">
      Samples for xPhcLogd report format
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  <h1>Simple Rule Server</h1>

<h2 id="intro">Intro<a class="headerlink" href="#intro" title="Permanent link">~</a></h2>
<p>The Simple Rule Server is a lightweight daemon to accomplish automation tasks and which is integrated into the <a href="../phc2mqtt">Phc2Mqtt</a> project,
we will furthermore refer to it as <strong>SRSD</strong>.</p>
<p>Operational behaviour of the SRSD is determined by a set of plain text rules stored in a file (rule-file)
which is loaded when the SRSD starts.
<a href="../phc2mqtt/#configure-simple-rule-server">Configure Simple Rule Server</a> describes how this rule-file is provisioned in the Phc2Mqtt project.</p>
<p>In general above rules are triggered by an event (unless otherwise stated), 
these can come from different sources like an MQTT client, HTTP server, a clock, a timer or the hosting application
(in casu Phc2Mqtt provides system and STMD events).</p>
<p>Some rules are able to store part of an event's content or a fixed value into an internal piece of memory called a state-object, 
which can be used in a condition.</p>
<p>A condition compares the value of a state-object to a fixed value to determine the flow of actions.</p>
<p>Finally, the purpose of SRSD is to execute actions to realise the automation tasks, 
this can be sending an MQTT message, execute a PHC command, starting or stopping a clock or timer, ...</p>
<h2 id="rule-syntax">Rule Syntax<a class="headerlink" href="#rule-syntax" title="Permanent link">~</a></h2>
<p>Rules are expressed in a simplified JSON format, removing redundant decoration, and are stored in a rule file. </p>
<p>Strings that contain ';:{}[]"\', a space, a tab, a carriage-return (CR) or line-feed (LF) need enclosing double-quotes, 
additionally the double-quote/backslash/tab/CR/LF need to be escaped as '\"', '\\', '\t', '\r' and '\n' respectively. </p>
<p>If a string does not contain above characters then it does not require enclosing double-quotes,
but they are allowed at the user's discretion.</p>
<p>A space/tab/CR/LF are considered white-space and are skipped, unless used inside a quoted string.</p>
<p>The pipe ('|') and ampersand ('&amp;') are used as special separator characters inside a data-filter and cannot be used in a string.</p>
<p>Comments can be specified at any position on a line by means of a semicolon, all following characters upto the end-of-line will be skipped
unless used inside a quoted string.</p>
<p>Keywords and delimiters (between single quotes) in rules are case-insensitive, actual data strings are case-sensitive.</p>
<div class="highlight"><pre><span></span><code><span class="na">rules          ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;rules:{&#39;</span><span class="w"> </span><span class="na">*[&lt;rule&gt; | &lt;comment&gt;] &#39;}&#39;</span>

<span class="na">comment        ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;;&#39;</span><span class="w"> </span><span class="k">[&lt;string&gt;]</span>

<span class="na">rule</span><span class="w">           </span><span class="o">:</span><span class="s">:= &lt;init-rule&gt; | &lt;exit-rule&gt; | &lt;state-rule&gt; | &lt;action-rule&gt;</span>

<span class="na">init-rule      ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;init:{&#39;</span><span class="w"> </span><span class="na">*&lt;action&gt; &#39;}&#39;</span>

<span class="na">exit-rule      ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;exit:{&#39;</span><span class="w"> </span><span class="na">*&lt;action&gt; &#39;}&#39;</span>

<span class="na">state-rule     ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;state:{&#39;</span><span class="w"> </span>
<span class="w">                     </span><span class="na">&#39;when</span><span class="o">:</span><span class="s">{&#39; *&lt;event&gt; &#39;}&#39;</span><span class="w"> </span>
<span class="w">                    </span><span class="k">[&#39;refine:{&#39; [&lt;modifier&gt;&#39;:&#39;&lt;string&gt;][&#39;keys:&#39;&lt;key-filters&gt;][&#39;math:&#39;&lt;term&gt;] &#39;}&#39;]</span>
<span class="w">                   </span><span class="na">&#39;}&#39;</span>
<span class="w">  </span><span class="na">modifier     ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;infix&#39;</span><span class="w"> </span><span class="na">| &#39;prefix&#39; | &#39;name&#39;</span>
<span class="w">  </span><span class="na">term</span><span class="w">         </span><span class="o">:</span><span class="s">:= &lt;oper&gt; (&lt;number&gt; | &lt;term&gt;)</span>
<span class="w">  </span><span class="na">oper         ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;+-*/%&amp;|^&#39;</span>

<span class="na">action-rule    ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;action:{&#39;</span>
<span class="w">                     </span><span class="na">&#39;when</span><span class="o">:</span><span class="s">{&#39; *&lt;event&gt; &#39;}&#39; &#39;then:{&#39; *&lt;action&gt; &#39;}&#39;</span><span class="w"> </span>
<span class="w">                   </span><span class="na">&#39;}&#39;</span>

<span class="na">action-rule    ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;action:{&#39;</span>
<span class="w">                     </span><span class="na">&#39;when</span><span class="o">:</span><span class="s">{&#39; *&lt;event&gt; &#39;}&#39;</span>
<span class="w">                     </span><span class="na">*(&#39;and</span><span class="o">:</span><span class="s">{&#39; *&lt;cond&gt; &#39;}&#39; &#39;then:{&#39; *&lt;action&gt; &#39;}&#39; )</span>
<span class="w">                      </span><span class="k">[&#39;else:{&#39; *&lt;action&gt; &#39;}&#39; ]</span>
<span class="w">                   </span><span class="na">&#39;}&#39;</span>


<span class="na">event          ::= &lt;source&gt;&#39;:{&#39; &#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;topic-filter&gt; [&#39;</span><span class="na">data</span><span class="o">:</span><span class="s">&#39;&lt;data-filter&gt;] &#39;</span><span class="na">}&#39;</span>
<span class="w">  </span><span class="na">source       ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;clock&#39;</span><span class="w"> </span><span class="na">| &#39;http&#39; | &#39;mqtt&#39; | &#39;stmd&#39; | &#39;system&#39; | &#39;timer&#39;</span>

<span class="na">cond           ::= &lt;source&gt;&#39;:{&#39; &#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &lt;oper&gt;&#39;</span><span class="o">:</span><span class="s">&#39;(&lt;string&gt;|&lt;number&gt;) &#39;</span><span class="na">}&#39;</span>
<span class="w">  </span><span class="na">source       ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;clock&#39;</span><span class="w"> </span><span class="na">| &#39;state&#39; | &#39;timer&#39;</span>
<span class="w">  </span><span class="na">oper         ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;eq&#39;</span><span class="w"> </span><span class="na">| &#39;ne&#39; | &#39;lt&#39; | &#39;gt&#39; | &#39;le&#39; | &#39;ge&#39;</span>

<span class="na">action</span><span class="w">         </span><span class="o">:</span><span class="s">:= &lt;clock-action&gt; | &lt;mqtt-action&gt; | &lt;stmd-action&gt; | &lt;state-action&gt; | &lt;timer-action&gt;</span>
<span class="w">  </span><span class="na">clock-action ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;clock:{&#39;</span><span class="w"> </span><span class="na">&#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &#39;</span><span class="na">days</span><span class="o">:</span><span class="s">&#39;</span><span class="err">&lt;days&gt; </span>
<span class="w">                           </span><span class="na">[&#39;on</span><span class="o">:</span><span class="s">&quot;&#39;</span><span class="w"> </span><span class="na">&lt;0-23&gt;:&lt;0-59&gt; &#39;&quot;&#39; &#39;off</span><span class="o">:</span><span class="s">&quot;&#39;</span><span class="w"> </span><span class="na">&lt;0-23&gt;</span><span class="o">:</span><span class="s">&lt;0-59&gt; &#39;&quot;&#39;] &#39;}&#39;</span>
<span class="w">    </span><span class="na">days</span><span class="w">       </span><span class="o">:</span><span class="s">:= sum of selected days: sun=1,mon=2,tue=4,wed=8,thu=16,fri=32,sat=64</span>
<span class="w">  </span><span class="na">mqtt-action  ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;mqtt:{&#39;</span><span class="w">  </span><span class="na">&#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &#39;</span><span class="na">data</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &#39;</span><span class="na">}&#39;</span>
<span class="w">  </span><span class="na">stmd-action  ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;stmd:{&#39;</span><span class="w">  </span><span class="na">&#39;ccmd</span><span class="o">:</span><span class="s">&#39;&lt;phc-cmd&gt; *[&#39;</span><span class="c1">;&#39;&lt;phc-cmd&gt;] &#39;}&#39;</span>
<span class="w">  </span><span class="na">state-action ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;state:{&#39;</span><span class="w"> </span><span class="na">&#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &#39;</span><span class="na">value</span><span class="o">:</span><span class="s">&#39;(&lt;string&gt;|&lt;number&gt;) &#39;</span><span class="na">}&#39;</span>
<span class="w">  </span><span class="na">timer-action ::</span><span class="o">=</span><span class="w"> </span><span class="s">&#39;timer:{&#39;</span><span class="w"> </span><span class="na">&#39;topic</span><span class="o">:</span><span class="s">&#39;&lt;string&gt; &#39;</span><span class="na">seconds</span><span class="o">:</span><span class="s">&#39;0-4294967295 &#39;</span><span class="na">}&#39;</span>

<span class="na">key-filters</span><span class="w">    </span><span class="o">:</span><span class="s">:= &lt;key-filter&gt; *[&#39;,&#39;&lt;key-filter&gt;]</span>
<span class="na">key-filter</span><span class="w">     </span><span class="o">:</span><span class="s">:= &lt;string&gt; | &#39;?&#39; | &#39;</span><span class="c1">#&#39; | &#39;*&#39;)</span>
<span class="na">topic-filter</span><span class="w">   </span><span class="o">:</span><span class="s">:= &lt;string&gt; | &#39;?&#39; | &#39;</span><span class="c1">#&#39; | &#39;*&#39;)</span>
<span class="w">  </span><span class="na">?</span><span class="w">            </span><span class="o">:</span><span class="s">:= any character (1)</span>
<span class="w">  </span><span class="c1">#            ::= 1 or more numerical digits</span>
<span class="w">  </span><span class="na">*</span><span class="w">            </span><span class="o">:</span><span class="s">:= any characters from this point on</span>

<span class="na">data-filter</span><span class="w">    </span><span class="o">:</span><span class="s">:= &lt;OR-pattern&gt;</span>
<span class="w">  </span><span class="na">OR-pattern</span><span class="w">   </span><span class="o">:</span><span class="s">:= &lt;AND-pattern&gt; *[&#39;|&#39; &lt;AND-pattern&gt;]</span>
<span class="w">  </span><span class="na">AND-pattern</span><span class="w">  </span><span class="o">:</span><span class="s">:= &lt;string&gt; *[&#39;&amp;&#39; &lt;string&gt;]</span>

<span class="na">phc-cmd</span><span class="w">        </span><span class="o">:</span><span class="s">:= refer to the PHC Command Reference</span>
<span class="na">number</span><span class="w">         </span><span class="o">:</span><span class="s">:= [&#39;-+&#39;] *&#39;0-9&#39; [ &#39;.&#39; *&#39;0-9&#39;]</span>
<span class="na">string</span><span class="w">         </span><span class="o">:</span><span class="s">:= [&#39;&quot;&#39;] *&lt;any-character&gt; [&#39;&quot;&#39;]</span>
</code></pre></div>
<h2 id="internal-objects">Internal Objects<a class="headerlink" href="#internal-objects" title="Permanent link">~</a></h2>
<p>SRSD knows a number of internal objects,<br />
they do not exist when SRSD starts but must be created/updated at runtime via an <a href="#action-rule">action rule</a> or a <a href="#state_rule">state rule</a>.</p>
<p>These objects are persistent as long as SRSD is running, when the SRSD stops their values are lost.</p>
<p>Each internal object has 3 attributes:<br />
- type   : can be clock, state or timer<br />
- topic  : a meaningful string describing the nature of the object<br />
- value  : the value of the object, this can be a string or a number with a maximum of 34 characters</p>
<p>Each object can be referenced by type + topic in a <a href="#conditions">condition</a> 
where it's value is compared to a condition-value to determine the flow of actions.</p>
<p>When a non-existing object is referred in a condition,
an temporary object will be created with default values depending on the object type, see below.</p>
<h3 id="clock-object">Clock Object<a class="headerlink" href="#clock-object" title="Permanent link">~</a></h3>
<p>A clock object can be used to perform periodic actions by specifying an on and off time and the days to apply.
It's default value is "off" (0).</p>
<p>You can use it in an action, refer to <a href="#clock-action">Clock Action</a></p>
<p>It will generate an event when it turns on or off, refer to <a href="#clock-event">Clock Event</a></p>
<p>You can use it's on/off value in a <a href="#clock-condition">Clock Condition</a>, either as number or as string</p>
<h3 id="state-object">State Object<a class="headerlink" href="#state-object" title="Permanent link">~</a></h3>
<p>A state object can be used to store runtime data for later use. It's default value is "" (0).</p>
<p>State objects can be created/updated implicitly with a <a href="#state-rule">State Rule</a> 
or explicitly with a <a href="#state-action">State Action</a></p>
<p>A state object cannot generate any events.</p>
<p>You can use it's value in a condition, refer to <a href="#state-condition">State Condition</a></p>
<h3 id="timer-object">Timer Object<a class="headerlink" href="#timer-object" title="Permanent link">~</a></h3>
<p>A timer object can be used to monitor the presence or absence of an event (dead man's switch), 
it's unit of time is expressed in seconds. It's default value is "off" (0).</p>
<p>You can use it in an action, refer to <a href="#timer-action">Timer Action</a></p>
<p>It will generate an event when it starts/stops/expires, refer to <a href="#timer-event">Timer Event</a></p>
<p>You can use it's on/off value in a condition, refer to <a href="#timer-condition">Timer Condition</a></p>
<h2 id="events">Events<a class="headerlink" href="#events" title="Permanent link">~</a></h2>
<p>In general a rule is triggered by an event (unless otherwise stated) 
which has 2 parts of information that uniquely define the event: topic and data. Each part has it's characteristic formats.</p>
<h3 id="topic-formats">Topic Formats<a class="headerlink" href="#topic-formats" title="Permanent link">~</a></h3>
<h4 id="full">Full<a class="headerlink" href="#full" title="Permanent link">~</a></h4>
<p>Fully identifies the object that generated the event, typically physical module + endpoint/channel:
<div class="highlight"><pre><span></span><code>topic:sta/omd.0.out0
</code></pre></div></p>
<h4 id="partial">Partial<a class="headerlink" href="#partial" title="Permanent link">~</a></h4>
<p>Partially identifies part of the object that generated the event, typically the physical module:
<div class="highlight"><pre><span></span><code>topic:sta/omd.0
</code></pre></div></p>
<h4 id="general">General<a class="headerlink" href="#general" title="Permanent link">~</a></h4>
<p>Does not identify the object that generated the event, it is a placeholder for topic-filtering:
<div class="highlight"><pre><span></span><code>topic:tzb/tele/SENSOR
</code></pre></div></p>
<h3 id="data-formats">Data Formats<a class="headerlink" href="#data-formats" title="Permanent link">~</a></h3>
<h4 id="flat">Flat<a class="headerlink" href="#flat" title="Permanent link">~</a></h4>
<p>Has no formatting and is typically combined with a full-topic (equals xPhcLogd compatible STMD reporting format):
<div class="highlight"><pre><span></span><code>flat-format ::= &lt;string&gt; | &lt;number&gt;
  string    ::= *(a-z A-Z 0-9 _-/.)
  number    ::= integer | floating
</code></pre></div>
Examples
<div class="highlight"><pre><span></span><code>data=outlt1
data=0
data=-25.9
</code></pre></div></p>
<h4 id="json">JSON<a class="headerlink" href="#json" title="Permanent link">~</a></h4>
<p>Follows the JSON syntax rules, allows multiple endpoints/attributes to be reported in key:value pairs:
<div class="highlight"><pre><span></span><code>json-format    ::= &#39;{&#39; &lt;key&gt; &#39;:&#39; &lt;value&gt; *[&#39;,&#39; &lt;key&gt; &#39;:&#39; &lt;value&gt;] &#39;}&#39;
  key          ::= &lt;string&gt;
  value        ::= &lt;string&gt; | &lt;number&gt; | &lt;object&gt; | &lt;array&gt; | &lt;boolean&gt; | &lt;null&gt;
  string       ::= &#39;&quot;&#39; *(a-z A-Z 0-9 _-/.) &#39;&quot;&#39;
  number       ::= integer | floating
  object       ::= { &lt;key&gt; : &lt;value&gt; *[, &lt;key&gt; : &lt;value&gt;] }
  array        ::= [ &lt;value&gt; *[, &lt;value&gt;] ]
  boolean      ::= false | true
  null         ::= null
</code></pre></div>
Examples
<div class="highlight"><pre><span></span><code>data={&quot;out0&quot;:1,&quot;out1&quot;:1}
data={&quot;Name&quot;:&quot;living/id3&quot;,&quot;MultiInValue&quot;:1,&quot;Click&quot;:&quot;single&quot;,&quot;Endpoint&quot;:2,&quot;LinkQuality&quot;:107}
</code></pre></div></p>
<h4 id="text">Text<a class="headerlink" href="#text" title="Permanent link">~</a></h4>
<p>Similar to JSON format but without the syntax decoration, allows multiple endpoints/attributes to be reported in key:value pairs:
<div class="highlight"><pre><span></span><code>text-format ::= &lt;key&gt; [&#39;:&#39; &lt;value&gt;] *[&#39;,&#39; &lt;key&gt; [&#39;:&#39; &lt;value&gt;]]
  key       ::= &lt;string&gt;
  value     ::= &lt;string&gt; | &lt;number&gt;
  string    ::= *(a-z A-Z 0-9 _-/.)
  number    ::= integer | floating
</code></pre></div>
Examples
<div class="highlight"><pre><span></span><code>data=out0:1,out1:1
</code></pre></div></p>
<h3 id="event-sources">Event Sources<a class="headerlink" href="#event-sources" title="Permanent link">~</a></h3>
<p>Events are generated by a source, these can be internal or external to the SRSD as explained here.</p>
<h4 id="clock-event">Clock Event<a class="headerlink" href="#clock-event" title="Permanent link">~</a></h4>
<p>Internal source, generating an event when the specified clock turns on or off:
<div class="highlight"><pre><span></span><code>when:{clock:{topic:daily data:on}}
when:{clock:{topic:daily data:off}}
</code></pre></div></p>
<h4 id="http-event">HTTP Event<a class="headerlink" href="#http-event" title="Permanent link">~</a></h4>
<p>External source, the result of an incoming HTTP request on the module's webserver, 
topic and data are contained in the HTTP query-string:
<div class="highlight"><pre><span></span><code>http-request ::= http://&lt;module-ip-address&gt;/srsd?&lt;query-string&gt;
query-string ::= &lt;topic&gt; [&quot;&amp;&quot;&lt;data&gt;]
</code></pre></div></p>
<p><div class="highlight"><pre><span></span><code>when:{http:{topic:ccmd data:imd.0.in0.outlt1}}
</code></pre></div>
The HTTP request that meets above event definition would be:
<div class="highlight"><pre><span></span><code>http://&lt;module-ip-address&gt;/srsd?ccmd&amp;imd.0.in0.outlt1
</code></pre></div></p>
<h4 id="mqtt-event">MQTT Event<a class="headerlink" href="#mqtt-event" title="Permanent link">~</a></h4>
<p>External source, the result of the MQTT client receiving an incoming publish message that 
matches any of the configured SRSD RX-Topic-Prefixes.
Refer to <a href="../phc2mqtt/#configure-simple-rule-server">Configure Simple Rule Server</a> in the Phc2Mqtt manual:
<div class="highlight"><pre><span></span><code>when:{mqtt:{topic:tzb/tele/SENSOR data:&quot;Click\&quot;:\&quot;single&amp;Endpoint\&quot;:2&quot;}}
</code></pre></div></p>
<h4 id="stmd-event">STMD Event<a class="headerlink" href="#stmd-event" title="Permanent link">~</a></h4>
<p>External source, generated by the STMD reporting function, topic and data format depend on the Reporting Format/Data Format:
<div class="highlight"><pre><span></span><code>when:{stmd:{topic:evt/imd.0.in0 data:outlt1}}
when:{stmd:{topic:evt/imd.0 data:&quot;in0:outlt1&quot;}}
when:{stmd:{topic:evt/imd.0 data:&quot;in0\&quot;:\&quot;outlt1&quot;}}
</code></pre></div></p>
<h4 id="system-event">System Event<a class="headerlink" href="#system-event" title="Permanent link">~</a></h4>
<p>External source, will generate predefined events from the Phc2Mqtt module's sub-systems:
<div class="highlight"><pre><span></span><code>when:{system:{topic:appl data:halting     }} ; module is going to halt
when:{system:{topic:appl data:rebooting   }} ; module is going to reboot
when:{system:{topic:mqtt data:connected   }} ; MQTT client connected to broker
when:{system:{topic:mqtt data:disconnected}} ; MQTT client disconnected from broker
when:{system:{topic:stmd data:started     }} ; STM daemon started
when:{system:{topic:stmd data:stopped     }} ; STM daemon stopped
when:{system:{topic:netw data:connected   }} ; network is online (got IP address)
when:{system:{topic:netw data:disconnected}} ; network is offline (lost IP address)
</code></pre></div>
The reason of existence for the system events comes from the startup order of the module's sub-systems. 
By default the SRSD will be started early during module boot. 
At that moment other sub-systems are not yet started and thus cannot execute actions from init rules.</p>
<p>By allowing SRSD to monitor when a given sub-system becomes active, you can take a matching action. 
For instance, you want to know when the MQTT client is connected to the broker so you can publish an 'online' message.</p>
<h4 id="timer-event">Timer Event<a class="headerlink" href="#timer-event" title="Permanent link">~</a></h4>
<p>Internal source, generating an event when the specified timer turns on/off or expires:
<div class="highlight"><pre><span></span><code>when:{timer:{topic:watchdog data:on}}
when:{timer:{topic:watchdog data:off}}
when:{timer:{topic:watchdog data:expired}}
</code></pre></div></p>
<h3 id="event-filtering">Event Filtering<a class="headerlink" href="#event-filtering" title="Permanent link">~</a></h3>
<p>For every incoming event the SRSD will iterate over the list of state/action-rules in the order they were defined.
If the topic-filter and optional data-filter match then the rule will be executed, otherwise it will be skipped.</p>
<h4 id="topic-filters">Topic-filters<a class="headerlink" href="#topic-filters" title="Permanent link">~</a></h4>
<p>Are used to match the event topic and support wildcard characters:<br />
- A question-mark (<b>?</b>) means that the character in that position can be any character<br />
- A hashtag (<b>#</b>) means one or more numeric digits match<br />
- An asterisk (<b>*</b>) means all following characters are a match<br />
- All other characters (<b>0-9</b>,<b>a-z</b>,<b>A-Z</b>, <b>_-/.</b>) require a 1-on-1 case-sensitive match</p>
<h4 id="data-filters">Data-filters<a class="headerlink" href="#data-filters" title="Permanent link">~</a></h4>
<p>Are used to match the event data and are composed from OR- and AND-patterns:<br />
- All strings in the AND-pattern must be present as-is (case-sensitive) in the event data for the AND-pattern to match<br />
- You can specify multiple AND-patterns combined in an OR-pattern, as soon as one AND-pattern matches, the data-filter matches</p>
<h4 id="key-filters">Key-filters<a class="headerlink" href="#key-filters" title="Permanent link">~</a></h4>
<p>Are used in state-rules to extract key:value pairs from text/JSON event data and support wildcard characters:<br />
- A <b>?</b> means that the character in that position can be any character<br />
- A <b>#</b> means one or more numeric digits match<br />
- An <b>*</b> means all following characters are a match<br />
- All other characters require a 1-on-1 case-sensitive match</p>
<p>Samples for illustration:
<div class="highlight"><pre><span></span><code>MQTT-event: tzb/tele/SENSOR = {&quot;Name&quot;:&quot;outside/lumi_nw&quot;,&quot;Illuminance&quot;:24699,&quot;Endpoint&quot;:1}
rule      : state:{ mqtt:{topic:tzb/tele/SENSOR data:&quot;Name\&quot;:\&quot;outside/lumi_nw&quot;}
                    refine:{prefix:lumi keys:Illuminance} }
result    : state-topic=lumi/Illuminance state-value=24699
</code></pre></div>
<div class="highlight"><pre><span></span><code>STMD-event: sta/omd.0 = out0:1,out4:0,out7:1
rule      : state:{ stmd:{topic:omd.# keys:out#} }
result    : state-topic=omd.0.out0 state-value=1
            state-topic=omd.0.out4 state-value=0
            state-topic=omd.0.out7 state-value=1
</code></pre></div>
<div class="highlight"><pre><span></span><code>MQTT-event: tzb/tele/SENSOR = {&quot;Name&quot;:&quot;test/id1&quot;,&quot;MultiInValue&quot;:1,&quot;Click&quot;:&quot;single&quot;,&quot;Endpoint&quot;:1,&quot;LinkQuality&quot;:139}
rule      : when:{ mqtt:{topic:tzb/tele/SENSOR data:&quot;Name\&quot;:\&quot;test/id1&amp;Click\&quot;:\&quot;single&amp;Endpoint\&quot;:1|Name\&quot;:\&quot;test/id1&amp;Click\&quot;:\&quot;single&amp;Endpoint\&quot;:2&quot;}}
</code></pre></div>
<div class="highlight"><pre><span></span><code>MQTT-event: p2m/evt/imw.8 = in0:ingt0
MQTT-event: p2m/evt/imw.8 = in1:ingt0
rule      : when:{ mqtt:{topic:p2m/evt/imw.8 data:&quot;in0:ingt0|in1:ingt0&quot;}}
</code></pre></div>
<div class="highlight"><pre><span></span><code>MQTT-event: test/parent.2/child.0  = value0:1
MQTT-event: test/parent.31/child.0 = value0:1
rule      : when:{ mqtt:{topic:test/parent.#/child.0 data:&quot;value0:1&quot;}}
</code></pre></div></p>
<h2 id="conditions">Conditions<a class="headerlink" href="#conditions" title="Permanent link">~</a></h2>
<p>In addition to event filtering we can add one or more conditions to an action rule to determine a specific flow of actions
in an <strong>and</strong>/<strong>then</strong>/<strong>else</strong> scheme, where each condition compares an internal object's value to a predefined value.</p>
<p>When a condition refers a non-existing internal object, SRSD will use a temporary object with a default value. 
Refer to <a href="#internal-objects">Internal Objects</a> for default values for each type of object.</p>
<p>A condition compares the referenced object's value with the condition-value using an operator,
when both values are a number (integer or floating) they will be compared numerical otherwise as text.</p>
<p>The result of a condition will always be <strong>true</strong> or <strong>false</strong>, when multiple conditions are present then the
result of each condition is AND-ed. In that case the global result will be true if all conditions are true.</p>
<h3 id="clock-condition">Clock Condition<a class="headerlink" href="#clock-condition" title="Permanent link">~</a></h3>
<p>Compares the actual state of a clock, following formats are supported:
<div class="highlight"><pre><span></span><code><span class="na">and</span><span class="o">:</span><span class="s">{clock:{topic:daily eq:on}}</span><span class="w"> </span><span class="c1">; same as 1</span>
<span class="na">and</span><span class="o">:</span><span class="s">{clock:{topic:daily ne:off}}</span><span class="c1">; same as 0</span>
<span class="na">and</span><span class="o">:</span><span class="s">{clock:{topic:daily eq:1}}</span><span class="w">  </span><span class="c1">; same as on</span>
<span class="na">and</span><span class="o">:</span><span class="s">{clock:{topic:daily ne:0}}</span><span class="w">  </span><span class="c1">; same as off</span>
</code></pre></div></p>
<h3 id="state-condition">State Condition<a class="headerlink" href="#state-condition" title="Permanent link">~</a></h3>
<p>Compare the actual value of a state-object, can be specified either as a string or a number:
<div class="highlight"><pre><span></span><code><span class="na">and</span><span class="o">:</span><span class="s">{state:{topic:weather     eq:sunny}}</span>
<span class="na">and</span><span class="o">:</span><span class="s">{state:{topic:temperature lt:21.5}}</span>
</code></pre></div></p>
<h3 id="timer-condition">Timer Condition<a class="headerlink" href="#timer-condition" title="Permanent link">~</a></h3>
<p>Compares the actual state of a timer, following formats are supported:
<div class="highlight"><pre><span></span><code><span class="na">and</span><span class="o">:</span><span class="s">{timer:{topic:watchdog eq:on}}</span><span class="w"> </span><span class="c1">; same as 1</span>
<span class="na">and</span><span class="o">:</span><span class="s">{timer:{topic:watchdog eq:off}}</span><span class="c1">; same as 0</span>
<span class="na">and</span><span class="o">:</span><span class="s">{timer:{topic:watchdog eq:1}}</span><span class="w">  </span><span class="c1">; same as on</span>
<span class="na">and</span><span class="o">:</span><span class="s">{timer:{topic:watchdog eq:0}}</span><span class="w">  </span><span class="c1">; same as off</span>
</code></pre></div></p>
<p>Examples:
<div class="highlight"><pre><span></span><code>object    : state:{topic:weather value:rainy}
condition : and:{state:{topic:weather eq:sunny}}
result    : false
</code></pre></div>
<div class="highlight"><pre><span></span><code>object    : state:{topic;weather value:rainy}
condition : and:{state:{topic:weather lt:sunny}}
result    : true
</code></pre></div>
<div class="highlight"><pre><span></span><code>object    : state:{topic:weather value:rainy}
condition : and:{state:{topic:weather lt:sunny} 
                 state:{topic:weather eq:rainday}}
result    : false
</code></pre></div>
<div class="highlight"><pre><span></span><code>object    : state:{topic:temperature value:25.0}
condition : and:{state:{topic:temperature eq:25}}
result    : true
</code></pre></div>
One or more <strong>and</strong> conditions can be specified and when evaluating to <strong>true</strong> 
SRSD will execute all following <strong>then</strong> actions after which the rule ends:
<div class="highlight"><pre><span></span><code>when:{ *&lt;event&gt; }
*[and:{ *&lt;cond&gt; } then:{ *&lt;action&gt; } ]
</code></pre></div>
This <strong>and</strong>/<strong>then</strong> pattern can be repeated with the same behaviour explained above.</p>
<p>When all previous conditions were not met then SRSD will execute all <strong>else</strong> actions, if present:
<div class="highlight"><pre><span></span><code>*[else &lt;action&gt;]
</code></pre></div></p>
<h2 id="actions">Actions<a class="headerlink" href="#actions" title="Permanent link">~</a></h2>
<h3 id="clock-action">Clock Action<a class="headerlink" href="#clock-action" title="Permanent link">~</a></h3>
<p>With this action you can stop a clock by setting days to 0, 
or start it by setting days to the or-ed value of each required day and specifying the on and off time:
<div class="highlight"><pre><span></span><code>then:{clock:{topic:daily days:0}}
then:{clock:{topic:daily days:127 on:&quot;7:00&quot; off:&quot;22:00&quot;}}
</code></pre></div></p>
<h3 id="mqtt-action">MQTT Action<a class="headerlink" href="#mqtt-action" title="Permanent link">~</a></h3>
<p>With this action you can send an MQTT publish message via the module's MQTT client, with the specified topic and data.
<div class="highlight"><pre><span></span><code>then:{mqtt:{topic:tzb/cmnd/ZbSend data:&quot;{\&quot;device\&quot;:\&quot;office/od4\&quot;,\&quot;send\&quot;:{\&quot;power\&quot;:\&quot;toggle\&quot;}}&quot;}}
then:{mqtt:{topic:m2p/cmd/ccmd data:&quot;omd.0.out0.toggle;omd.4.out7.toggle&quot;}}
then:{mqtt:{topic:m2p/cmd/ccmd data:omd.0.out0.ontimed.30}}
</code></pre></div></p>
<h3 id="stmd-action">STMD Action<a class="headerlink" href="#stmd-action" title="Permanent link">~</a></h3>
<p>Send a list of phc-cmd's (ccmd) to the module's STMD sub-system, which will handle the commands depending on it's Operating Mode.
<div class="highlight"><pre><span></span><code>then:{stmd:{ccmd:&quot;jrm.1.out0.stop.0;jrm.1.out0.delayedup.0.0.5.150&quot;}}
</code></pre></div></p>
<h3 id="state-action">State Action<a class="headerlink" href="#state-action" title="Permanent link">~</a></h3>
<p>With this action you explicitly create or update an internal state-object that you can use in a condition. The state-object 
value can store upto 34 characters of string data, any longer data is truncated.
<div class="highlight"><pre><span></span><code>then:{state:{topic:weather value:sunny}}
then:{state:{topic:temperature value:21.6}}
</code></pre></div></p>
<h3 id="timer-action">Timer Action<a class="headerlink" href="#timer-action" title="Permanent link">~</a></h3>
<p>With this action you can stop a timer by setting seconds to 0, or start it by setting seconds to a non-zero value:
<div class="highlight"><pre><span></span><code>then:{timer:{topic:watchdog seconds:0}}
then:{timer:{topic:watchdog seconds:60}}
</code></pre></div></p>
<h2 id="rules">Rules<a class="headerlink" href="#rules" title="Permanent link">~</a></h2>
<h3 id="init-rule">Init Rule<a class="headerlink" href="#init-rule" title="Permanent link">~</a></h3>
<p>When the SRSD starts it will execute all init rules without the need for an event to trigger the rule.</p>
<p>An init rule executes any action but be aware that not all actions may execute as the targeted sub-system may not yet be active.</p>
<p>When the Phc2Mqtt module boots, the different sub-systems will start each in turn. Typically STMD first, then SRSD, Wifi, HTTP server and MQTT client.
In this case it will not be possible to send an MQTT message in an init rule. Checkout the <a href="#system-event">system events</a> to handle this problem.</p>
<p>Ofcourse SRSD can also be started manually from the configuration page, at that moment the rest of the module is fully operational and
it will be possible to send an MQTT message.</p>
<div class="highlight"><pre><span></span><code>init:{
 state:{topic:sta/daynight value:day}
 mqtt :{topic:sta/srsd     data:online}
 stmd :{ccmd:&quot;imw.0.led4.blink;omd.0.out0.on&quot;}
 timer:{topic:watchdog     seconds:60}
 clock:{topic:daily        days:127 on:&quot;7:00&quot; off:&quot;22:00&quot;}
}
</code></pre></div>
<h3 id="exit-rule">Exit Rule<a class="headerlink" href="#exit-rule" title="Permanent link">~</a></h3>
<p>When the SRSD stops it will execute all exit rules without the need for an event to trigger the rule.</p>
<p>An exit rule executes any action but note that some actions make no sense (state/timer/clock) as the SRSD will stop any activity.
<div class="highlight"><pre><span></span><code>exit:{
 state:{topic:sta/daynight value:none}
 mqtt :{topic:sta/srsd     data:offline}
 stmd :{ccmd:&quot;imw.0.led4.off;omd.0.out0.off&quot;}
 timer:{topic:watchdog     seconds:0}
 clock:{topic:daily        days:0}
}
</code></pre></div></p>
<h3 id="state-rule">State Rule<a class="headerlink" href="#state-rule" title="Permanent link">~</a></h3>
<p>State rules are triggered by incoming events when matching the topic-filter and optional data-filter.</p>
<p>Their purpose is to extract information from the event-topic/event-data and store that into one or more state-objects for later reference.</p>
<p>A state-object's value can store upto 34 characters of string data, any longer data is truncated.</p>
<p>The simplest form of a state rule will use the event-topic as state-object topic and copy the event-data to the state-object's value.</p>
<p>To accomplish more complex transformations you can refine the rule with the <strong>&lt;modifier&gt;</strong> and/or <strong>keys</strong> parameters. 
Depending on their combination the resulting state-objects will have a different topic and value as specified below:
<div class="highlight"><pre><span></span><code>modifier | keys | state-object-topic             | state-object-value
---------+------+--------------------------------+--------------------
-        | -    | &lt;evt-topic&gt;                    | &lt;evt-data&gt;
-        | x    | &lt;evt-topic&gt;/&lt;key-name&gt;         | &lt;key-value&gt;
infix    | -    | &lt;evt-topic&gt;/&lt;infix&gt;            | &lt;evt-data&gt;
infix    | x    | &lt;evt-topic&gt;/&lt;infix&gt;/&lt;key-name&gt; | &lt;key-value&gt;
prefix   | -    | &lt;prefix&gt;                       | &lt;evt-data&gt;
prefix   | x    | &lt;prefix&gt;/&lt;key-name&gt;            | &lt;key-value&gt;
name     | -    | &lt;name&gt;                         | &lt;evt-data&gt;
name     | x    | &lt;name&gt;                         | &lt;key-value&gt;
</code></pre></div></p>
<h4 id="keys">keys<a class="headerlink" href="#keys" title="Permanent link">~</a></h4>
<p>Events with a full topic typically have flat data associated with it, 
to handle this we do not use the &lt;modifier&gt; nor &lt;keys&gt; parameters.</p>
<p>The resulting state-object's topic will be equal to the event's topic, and it's value equal to the event's data.
This rule format covers the xPhcLogd compatible STMD reporting format.</p>
<p>All other events with a partial or general topic will typically have text or JSON formated data with key/value pairs,
the SRSD will parse them as follows.</p>
<p>Text format data:
The event data is first split into key/value pairs with a comma as separator, then split into key-name and key-value with a colon as separator:
<div class="highlight"><pre><span></span><code>Event data : out0:1,out1:0,out2:0,out3:0,out4:0,out5:1,out6:0,out7:0
Parsed as  : key-name=out0 key-value=1
             key-name=out1 key-value=0
             key-name=out2 key-value=0
             key-name=out3 key-value=0
             key-name=out4 key-value=0
             key-name=out5 key-value=1
             key-name=out6 key-value=0
             key-name=out7 key-value=0
</code></pre></div>
JSON format data:
The event data is parsed following the JSON specification:
<div class="highlight"><pre><span></span><code>Event data : {&quot;Device&quot;:&quot;0x73C9&quot;,&quot;Name&quot;:&quot;outside/lumi_nw&quot;,&quot;Illuminance&quot;:24699,&quot;Endpoint&quot;:1}
Parsed as  : key-name=Device      key-value=0x73C9
             key-name=Name        key-value=outside/lumi_nw
             key-name=Illuminance key-value=24699
             key-name=Endpoint    key-value=1
</code></pre></div>
For each parsed key present in the <strong>keys</strong> parameter, SRSD will create/update a state-object to store the key-value.</p>
<h4 id="examples">examples<a class="headerlink" href="#examples" title="Permanent link">~</a></h4>
<p><div class="highlight"><pre><span></span><code>event       : topic=sta/omd.0.out0 data=1
rule        : state:{
               stmd:{topic:sta/omd.0.out0}
              }
state-object: topic=sta/omd.0.out0 value=1
</code></pre></div>
<div class="highlight"><pre><span></span><code>event       : topic=evt/imd.0.in0 data=outlt1
rule        : state:{
               stmd:{topic:evt/imd.0.in0}
              }
state-object: topic=evt/imd.0.in0 value=outlt1
</code></pre></div>
<div class="highlight"><pre><span></span><code>event       : topic=sta/omd.0 data=out0:1,out4:0,out7:1
rule        : state:{
               stmd:{topic:sta/omd.0 keys:out#}
              }
state-object: topic=sta/omd.0.out0 value=1
              topic=sta/omd.0.out4 value=0
              topic=sta/omd.0.out7 value=1
</code></pre></div>
<div class="highlight"><pre><span></span><code>event       : topic=tzb/tele/SENSOR data={&quot;Device&quot;:&quot;0x73C9&quot;,&quot;Name&quot;:&quot;outside/lumi_nw&quot;,&quot;Illuminance&quot;:24699,&quot;Endpoint&quot;:1}
rule        : state:{
               mqtt:{topic:tzb/tele/SENSOR data:outside/lumi_nw} 
               refine:{infix:lumi keys:Illuminance}
              }
state-object: topic=tzb/tele/SENSOR/lumi/Illuminance value=24699
</code></pre></div>
<div class="highlight"><pre><span></span><code>event       : topic=tzb/tele/SENSOR data={&quot;Device&quot;:&quot;0x73C9&quot;,&quot;Name&quot;:&quot;outside/lumi_nw&quot;,&quot;Illuminance&quot;:24699,&quot;Endpoint&quot;:1}
rule        : state:{
               mqtt:{topic:tzb/tele/SENSOR data:outside/lumi_nw} 
               refine:{prefix:lumi keys:Illuminance,Endpoint}
              }
state-object: topic=lumi/Illuminance value=24699
              topic=lumi/Endpoint value=1
</code></pre></div>
<div class="highlight"><pre><span></span><code>event       : topic=sta/omd.0 data=out0:1
rule        : state:{
               stmd topic:sta/omd.0 data:out0} 
               refine:{keys:out0 name:bathroom/light}
              }
state-object: topic=bathroom/light value=1
</code></pre></div></p>
<h3 id="action-rule">Action Rule<a class="headerlink" href="#action-rule" title="Permanent link">~</a></h3>
<p>Action rules are triggered by an incoming event when matching the topic-filter and optional data-filter, 
see <a href="#event-filtering">event filtering</a> for details.</p>
<p>Additional <a href="#conditions">conditions</a> may be defined that determine the flow of actions executed.</p>
<h2 id="rule-samples">Rule Samples<a class="headerlink" href="#rule-samples" title="Permanent link">~</a></h2>
<h3 id="samples-for-text-or-json-report-format">Samples for Text or JSON report format<a class="headerlink" href="#samples-for-text-or-json-report-format" title="Permanent link">~</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These sample rules expect the <a href="../phc2mqtt/#configure-stmd-reporting">STMD Reporting</a> Format to be 'Text' or 'JSON'
and Data Format to be 'Binary'.</p>
</div>
<p>Simple controlling one or more outputs with one or more buttons:
<div class="highlight"><pre><span></span><code>action:{
 when:{
  ; clicking on a PHC button will trigger
  stmd:{ topic:evt/imw.13 data:&quot;in4:outlt1&quot; }

  ; or clicking on an Aqara Opple 3 band Zigbee button
  mqtt:{ topic:tzb/tele/SENSOR data:&quot;Name\&quot;:\&quot;aqara/inputs&amp;Click\&quot;:\&quot;single&amp;Endpoint\&quot;:4&quot; }
 }; when

 then:{
  ; toggle a PHC output
  stmd:{ ccmd:omd.4.out0.toggle }

  ; send multiple commands, note the double quotes are needed for the ; between the commands
  stmd:{ ccmd:&quot;omd.4.out0.toggle;omd.4.out3.ontimed.5&quot; }

  ; toggle an IKEA Zigbee outlet
  mqtt:{ topic:tzb/cmnd/ZbSend data:&quot;{\&quot;device\&quot;:\&quot;ikea/outlet\&quot;,\&quot;send\&quot;:{\&quot;power\&quot;:\&quot;toggle\&quot;}}&quot; }
 }; then
}; action
</code></pre></div></p>
<h3 id="samples-for-xphclogd-report-format">Samples for xPhcLogd report format<a class="headerlink" href="#samples-for-xphclogd-report-format" title="Permanent link">~</a></h3>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>These sample rules expect the <a href="../phc2mqtt/#configure-stmd-reporting">STMD Reporting</a> Format to be 'xPhcLogd compatible'
and Data Format to be 'Binary'.</p>
</div>
<p>Simple controlling one or more outputs with one or more buttons:
<div class="highlight"><pre><span></span><code>action:{
 when:{
  ; clicking on a PHC button will trigger
  stmd:{ topic:evt/imw.13.in4 data:outlt1 }

  ; or clicking on an Aqara Opple 3 band Zigbee button
  mqtt:{ topic:tzb/tele/SENSOR data:&quot;Name\&quot;:\&quot;aqara/inputs&amp;Click\&quot;:\&quot;single&amp;Endpoint\&quot;:4&quot; }
 }; when

 then:{
  ; toggle a PHC output
  stmd:{ ccmd:omd.4.out0.toggle }

  ; toggle an IKEA Zigbee outlet
  mqtt:{ topic:tzb/cmnd/ZbSend data:&quot;{\&quot;device\&quot;:\&quot;ikea/outlet\&quot;,\&quot;send\&quot;:{\&quot;power\&quot;:\&quot;toggle\&quot;}}&quot; }
 }; then
}; action
</code></pre></div></p>
<p>Controlling a PHC shutter with 2 PHC buttons:
<div class="highlight"><pre><span></span><code>action:{
 ; stop the shutter
 when:{
  stmd:{ topic:evt/imw.11.in0 data:ingt0 }
  stmd:{ topic:evt/imw.11.in1 data:ingt0 }
 }; when

 then:{
  stmd:{ ccmd:jrm.5.out2.stop.0 }
 }; then
}; action

action:{
 ; lower the shutter 15 seconds then lift 2 seconds to give some openings
 when:{
  stmd:{ topic:evt/imw.11.in0 data:ingt1 }
 };when
 then:{
  stmd:{ ccmd:jrm.5.out2.delayeddowntip.0.0.1.150.20 }
 }; then
}; action

action:{
 ; raise the shutter 15 seconds all the way up
 when:{
  stmd:{ topic:evt/imw.11.in1 data:ingt1 }
 };when
 then:{
  stmd:{ ccmd:jrm.5.out2.delayedup.0.0.1.150 }
 }; then
}; action
</code></pre></div></p>
<p>Using a Zigbee humidity sensor to drive a bathroom ventilator:
<div class="highlight"><pre><span></span><code>init:{
 ; initialise the fan state to on
 state:{ topic:bathroom/fan value:on }
 stmd :{ ccmd:omd.2.out5.on }
}; init

state:{
 ; collect runtime sensor data
 mqtt:{ topic:tzb/tele/SENSOR data:bathroom/sensor }
 refine:{ prefix:bathroom/sensor keys:Temperature,Humidity}
}; state

action:{
 ; let new humidity reading trigger the rule
 when:{
  mqtt:{ topic:tzb/tele/SENSOR data:bathroom/sensor&amp;Humidity&quot; }
 }; when

 ; if fan off and humidity more than 75% then turn fan on
 and:{
  state:{ topic:bathroom/fan eq:off }
  state:{ topic:bathroom/sensor/Humidity gt:75 }
 }; if

 then:{
  state:{ topic:bathroom/fan value:on }
  stmd :{ ccmd:omd.2.out5.on }
 }; then

 ; if fan on and humidity less than 70% then turn fan off
 and:{
  state:{ topic:bathroom/fan eq:on }
  state:{ topic:bathroom/sensor/Humidity lt:70 }
 }; if

 then:{
  state:{ topic:bathroom/fan value:off }
  stmd :{ ccmd:omd.2.out5.off }
 }; then
}; action
</code></pre></div></p>
<p>Automatic night lights with a Zigbee light sensor:
<div class="highlight"><pre><span></span><code>init:{
 ; initialise to night as the sensor will send updates during day
 state:{ topic:daynight value:night }
 stmd :{ ccmd:&quot;omd.0.out4.on;omd.4.out2.on&quot; }
}; init

state:{
 ; collect runtime sensor data
 mqtt:{ topic:tzb/tele/SENSOR data:outside/lumi_nw }
 refine:{ prefix:outside keys:Illuminance }
}; state

action:{
 ; let new illuminance reading trigger the rule
 when:{
  mqtt:{ topic:tzb/tele/SENSOR data:outside/lumi_nw&amp;Illuminance&quot; }
 }; when

 ; going from day to night -&gt; turn on lights
 and:{
  state:{ topic:daynight eq:day }
  state:{ topic:outside/Illuminance lt:5000 }
 }; if

 then:{
  state:{ topic:daynight value:night }
  stmd :{ ccmd:&quot;omd.0.out4.on;omd.4.out2.on&quot; }
 }; then

 ; going from night to day -&gt; turn off lights
 and:{
  state:{ topic:daynight eq:night }
  state:{ topic:outside/Illuminance gt:5500 }
 }; if

 then:{
  state:{ topic:daynight value:day }
  stmd :{ ccmd:&quot;omd.0.out4.off;omd.4.out2.off&quot; }
 }; then
}; action
</code></pre></div></p>
<p>Sample how to step through a series of state values pressing a button:
<div class="highlight"><pre><span></span><code>; set initial color
init:{ state:{ topic:mycolor value:white } }

action:{
 ; each time you press/release a button
 when:{ stmd:{ topic:evt/imw.8.in0 data:outlt1 } }

 and: { state:{ topic:mycolor eq:white } }
 then:{ state:{ topic:mycolor value:blue } }

 and: { state:{ topic:mycolor eq:blue } }
 then:{ state:{ topic:mycolor value:green } }

 and: { state:{ topic:mycolor eq:green } }
 then:{ state:{ topic:mycolor value:cyan } }

 and: { state:{ topic:mycolor eq:cyan } }
 then:{ state:{ topic:mycolor value:red } }

 and: { state:{ topic:mycolor eq:red } }
 then:{ state:{ topic:mycolor value:purple } }

 and: { state:{ topic:mycolor eq:purple } }
 then:{ state:{ topic:mycolor value:yellow } }

 else:{ state:{ topic:mycolor value:white } }
}; action
</code></pre></div></p>







  
  






                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.tabs.sticky", "navigation.instant", "navigation.top", "navigation.tracking"], "search": "../assets/javascripts/workers/search.6ce7567c.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.88dd0f4e.min.js"></script>
      
    
  </body>
</html>